<!DOCTYPE html>
<html lang="pt-BR" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard • Unidade Bandeirantes-290</title>
  <style>
    /* ===== Base ===== */
:root{
  color-scheme: light dark;
  --bg:#f6f7fb;
  --surface:#ffffff;
  --surface-elev:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --border:#e5e7eb;
  --accent:#22c55e;
  --accent-ink:#052e16;
  --danger:#ef4444;
  --warn:#f59e0b;
  --ok:#10b981;
  --shadow:0 10px 30px rgba(2,6,23,.08);
  --radius:16px;
  --radius-xl:18px;
  --fs-h1:clamp(1.6rem,1.1rem + 2.2vw,2.6rem);
  --fs-lg:1rem;
  --fs-sm:.9rem;

  /* enhancements */
  --border: color-mix(in oklab, var(--text) 14%, transparent);
  --ring: 0 0 0 3px color-mix(in oklab, var(--accent) 35%, transparent);
}

:root[data-theme="dark"]{
  --bg:#0b1020;
  --surface:#0f1629;
  --surface-elev:#0f1629;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --border:#1f2937;
  --accent:#22d36a;
  --shadow:0 10px 30px rgba(0,0,0,.45);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Helvetica Neue",Helvetica,sans-serif;
  background:var(--bg);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* ===== Header ===== */
header{
  position: relative;
  display: grid;
  gap: 12px;
  justify-items: center;
  text-align: center;
  padding: clamp(20px, 3vw, 32px) 16px;
  border: 1px solid var(--border);
  border-radius: var(--radius-xl);
  background:
    radial-gradient(1200px 50% at 50% -10%,
      color-mix(in oklab, var(--accent) 16%, transparent),
      transparent 60%),
    linear-gradient(180deg,
      color-mix(in oklab, var(--surface) 95%, transparent),
      var(--surface-elev));
  box-shadow: var(--shadow);
  overflow: hidden;
  overflow: clip;
  isolation: isolate;
  backdrop-filter: blur(6px);

  max-width: 1200px;           /* NOVO: largura máxima */
  margin: 16px auto;           /* NOVO: centraliza */
}

.brand{ display:grid; justify-items:center; gap:6px; }
h1{ margin:0; font-size:var(--fs-h1); font-weight:900; letter-spacing:-.02em; }
.subtitle{ color:var(--muted); font-size:clamp(.95rem,.9rem + .2vw,1.15rem); font-weight:700; margin:4px 0 0; }

.header-actions{
  position:absolute; top:12px; right:12px;
  display:flex; gap:10px; align-items:center; z-index:2;
}
@media (max-width:560px){
  .header-actions{ position:static; order:-1; justify-content:center; }
}

/* ===== Botão icônico ===== */
.icon-btn{
  --pad-x: 12px;
  position: relative;
  border: 1px solid var(--border);
  background: linear-gradient(180deg,
      color-mix(in oklab, var(--surface-elev) 85%, transparent),
      color-mix(in oklab, var(--surface) 100%, transparent));
  color: var(--text);
  border-radius: 999px;
  padding: 8px var(--pad-x);
  cursor: pointer;
  display: inline-flex; align-items: center; gap: 8px;
  box-shadow: var(--shadow);
  transition: transform .18s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease, opacity .18s ease;
  will-change: transform;
  backdrop-filter: blur(4px);
}
.icon-btn:hover{ background: color-mix(in oklab, var(--accent) 12%, var(--surface)); transform: translateY(-1px); }
.icon-btn:active{ transform: translateY(0); box-shadow: 0 2px 10px rgba(0,0,0,.2) inset; }
.icon-btn:focus-visible{ outline: none; box-shadow: var(--shadow), var(--ring); }
.icon-btn.ghost{ background: transparent; border-color: color-mix(in oklab, var(--accent) 30%, transparent); }
.icon-btn.primary{ background: color-mix(in oklab, var(--accent) 24%, var(--surface)); border-color: color-mix(in oklab, var(--accent) 38%, transparent); }
.icon-btn.icon-only{ --pad-x: 10px; padding: 8px; aspect-ratio:1/1; justify-content:center; }
.icon-btn.badge::after{
  content:""; position:absolute; top:6px; right:6px;
  width:8px; height:8px; border-radius:999px;
  background: color-mix(in oklab, var(--accent) 70%, red 10%);
  box-shadow: 0 0 0 2px var(--surface);
}
/* tooltip */
.icon-btn[data-tooltip]{ position:relative; }
.icon-btn[data-tooltip]::before{
  content: attr(data-tooltip);
  position: absolute;
  bottom: calc(100% + 8px); left: 50%;
  transform: translate(-50%, 8px);
  padding: 6px 10px; font-size:.825rem; color: var(--text);
  background: color-mix(in oklab, var(--surface) 80%, black 10%);
  border: 1px solid var(--border); border-radius: 8px; white-space: nowrap;
  opacity:0; pointer-events:none; transition: opacity .18s ease, transform .18s ease;
  box-shadow: var(--shadow);
}
.icon-btn:hover::before{ opacity:1; transform: translate(-50%, 0); }

/* animação header */
@media (prefers-reduced-motion: no-preference){
  header{ animation: fadeSlide .36s ease both; }
  @keyframes fadeSlide{
    from{ opacity:0; transform: translateY(-6px); }
    to{ opacity:1; transform: translateY(0); }
  }
}

/* ===== Tabs ===== */
.tabs{
  position:sticky; top:0; z-index:30;
  display:flex; gap:8px; flex-wrap:nowrap; justify-content:center;
  padding:8px 16px 12px; margin:0;
  background:linear-gradient(var(--bg),color-mix(in oklab,var(--bg) 78%,transparent));
  backdrop-filter:blur(4px);
  border-bottom:1px solid var(--border);
  overflow-x:auto; scrollbar-width:thin; -webkit-overflow-scrolling:touch;
}
.tab{
  appearance:none; border:1px solid var(--border);
  background:var(--surface); color:var(--text);
  border-radius:999px; padding:10px 18px; font-size:1.05rem; font-weight:800; cursor:pointer;
  transition: background .2s ease, border-color .2s ease, transform .15s ease; position:relative;
}
.tab:hover{ background:color-mix(in oklab,var(--accent) 12%,var(--surface)); transform:translateY(1px); }
.tab.active{ background:var(--text); color:#fff; border-color:var(--text); }
.tab .badge-pill{
  position:absolute; top:-6px; right:-6px;
  background:var(--accent); color:var(--accent-ink);
  border-radius:999px; font-size:.7rem; font-weight:900; padding:2px 6px; border:1px solid var(--border);
}

/* Indicador deslizante */
.tab-indicator{
  position:absolute; bottom:4px; height:3px; border-radius:999px;
  background: color-mix(in oklab, var(--accent) 60%, var(--text));
  transition: left .25s ease, width .25s ease;
}

/* ===== KPIs ===== */
.kpis{
  max-width:1200px; margin:8px auto 0; padding:8px 16px 0;
  display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
}
.kpi-card{ background:var(--surface); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); padding:12px 14px; display:grid; gap:6px; }
.kpi-title{ color:var(--muted); font-size:.9rem; font-weight:700; }
.kpi-value{ font-size:1.45rem; font-weight:900; }
.kpi-hint{ font-size:.8rem; color:var(--muted) }

/* ===== Cards ===== */
.main{
  max-width:1200px; margin:0 auto; padding:16px;
  display:grid; gap:18px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
}
.card{
  position:relative; background:var(--surface); border:1px solid var(--border); border-radius:var(--radius);
  box-shadow:var(--shadow); overflow:hidden; outline:none;
  transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
  display:grid; grid-template-rows:auto 1fr auto; min-height:180px; isolation:isolate;
}
.card:where(:hover,:focus-within){ transform:translateY(3px); border-color:color-mix(in oklab,var(--accent) 30%,var(--border)); box-shadow:0 18px 50px rgba(2,6,23,.12); }
.card-header{ display:flex; align-items:center; gap:12px; padding:14px; }
.card-thumb{
  position: relative;
  top: .2em;
  left: .2em;
  width: 64px; height: 64px;
  transition: .3s ease-in-out;
  border-radius: 10px;
  object-fit: cover;
}
.card-title{ font-weight:700; font-size:var(--fs-lg); }
.card-sub{ color:var(--muted); font-size:var(--fs-sm); }
.card-body{ padding:0 14px 6px; display:grid; gap:8px }
.kv{ display:grid; gap:6px; font-size:var(--fs-sm); }
.kv b{ font-weight:600; color:var(--muted); }
.kpi{ display:grid; gap:8px }
.badge{
  display:inline-flex; align-items:center; gap:6px;
  background:color-mix(in oklab,var(--accent) 20%,transparent);
  color:var(--text); border:1px solid color-mix(in oklab,var(--accent) 40%,var(--border));
  padding:6px 8px; border-radius:999px; font-size:.8rem; font-weight:700; width:max-content;
}
.progress{ height:8px; background:color-mix(in oklab,var(--surface) 70%,var(--bg)); border-radius:999px; border:1px solid var(--border); overflow:hidden }
.progress > i{ display:block; height:100%; width:0; transition: width .4s ease, background-color .2s ease }
.progress > i.bad{ background:var(--danger) }
.progress > i.warn{ background:var(--warn) }
.progress > i.ok{ background:var(--ok) }
.spark{ width:100%; height:36px }
.card-footer{ display:flex; align-items:center; justify-content:space-between; padding:6px 14px 14px }
.price{ font-weight:800; letter-spacing:.2px }
.btn{
  appearance:none; border:1px solid var(--border);
  background:var(--text); color:#fff; font-weight:700; font-size:.9rem;
  border-radius:12px; padding:10px 12px; cursor:pointer;
  transition: transform .15s ease, background-color .2s ease, color .2s ease, border-color .2s ease;
}
.btn:hover{ background:var(--accent); color:var(--accent-ink); border-color:transparent; transform:translateY(1px) }

/* ===== Skeleton ===== */
.card.loading::after{
  content:''; position:absolute; inset:0;
  background:linear-gradient(110deg,transparent 0%,color-mix(in oklab,var(--bg) 85%,var(--surface)) 40%,transparent 80%);
  background-size:200% 100%; animation:shimmer 1.4s linear infinite; pointer-events:none;
}
@keyframes shimmer{ to{ background-position-x:-200% } }

/* ===== Overlay/Form ===== */
.overlay{ position:fixed; inset:0; display:none; place-items:center; background:color-mix(in oklab,black 35%,transparent); backdrop-filter:blur(3px); z-index:50; padding:16px }
.overlay.active{ display:grid }
.form{ width:min(560px,92vw); background:var(--surface); border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); padding:18px; display:grid; gap:12px; position:relative }
.form h2{ margin:0 0 4px; font-size:1.05rem }
.form .close{ position:absolute; top:10px; right:10px; border:none; background:transparent; color:var(--muted); font-size:20px; cursor:pointer; line-height:1 }
.row{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
@media(max-width:560px){ .row{ grid-template-columns:1fr } }
.field{ display:grid; gap:6px }
.label{ font-size:.85rem; color:var(--muted) }
.hint{ font-size:.75rem; color:var(--muted) }
.error-msg{ font-size:.8rem; color:var(--danger); min-height:1em }
.input{
  width:100%; border:1px solid var(--border); background:transparent; color:var(--text);
  border-radius:10px; padding:10px 12px; font-size:1rem; outline:none
}
.input:focus{ border-color:var(--accent); box-shadow:0 0 0 3px color-mix(in oklab,var(--accent) 25%,transparent) }
.input[readonly]{ background:color-mix(in oklab,var(--surface) 70%,var(--bg)); color:var(--muted) }
.input.error{ border-color:var(--danger)!important; box-shadow:0 0 0 3px color-mix(in oklab,var(--danger) 30%,transparent)!important }
.actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:4px }
.btn-secondary{ background:transparent; color:var(--text); border-color:var(--border) }
.btn-secondary:hover{ background:color-mix(in oklab,var(--accent) 12%,transparent); color:var(--text) }

/* ===== Materiais ===== */
.materials{ max-width:1200px; margin:10px auto 40px; padding:0 16px }
.materials h3{ margin:10px 0 6px }
.grid{ display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)) }
.res-card{ background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:var(--shadow); display:grid; gap:8px }
.res-card .tag{ font-size:.75rem; color:var(--muted) }
.res-card a{ color:var(--text); font-weight:700; text-decoration:none }
.res-card a:hover{ color:var(--accent) }

/* ===== Toast ===== */
.toast{
  position:fixed; bottom:18px; left:50%; transform:translate(-50%, 0);
  background:var(--text); color:#fff; border-radius:12px; padding:10px 14px; font-size:.9rem;
  box-shadow:var(--shadow); opacity:0; pointer-events:none; transition: opacity .25s ease, transform .25s ease; z-index:60
}
.toast.show{ opacity:1; transform:translate(-50%, -6px) }

/* ===== Acessibilidade ===== */
@media (prefers-reduced-motion: reduce){
  *{ transition:none!important; animation:none!important }
}
  </style>
</head>
<body>
  <!-- HEADER MODERNO -->
<header class="app-header">
  <div class="brand">
    <h1>Unidade de Bandeirantes-290</h1>
    <p class="subtitle">Operação • Estoques • Pessoas • Armazenagem</p>
  </div>

  <div class="header-actions">
    <button id="themeToggle" class="icon-btn" title="Alternar tema" aria-pressed="false">🌗 Tema</button>
    <button id="refreshBtn" class="icon-btn" title="Atualizar">⟳ Atualizar</button>
  </div>

  <nav class="tabs" id="tabs" aria-label="Seções do painel" role="tablist">
    <button class="tab active" data-cat="operacao" role="tab" aria-selected="true">📊 Operação</button>
    <button class="tab" data-cat="estoques" role="tab" aria-selected="false">🌾 Estoques</button>
    <button class="tab" data-cat="pessoas" role="tab" aria-selected="false">👥 Pessoas</button>
    <button class="tab" data-cat="armazenagem" role="tab" aria-selected="false">🏭 Armazenagem</button>
    <span class="tab-indicator" aria-hidden="true"></span>
  </nav>
</header>

  <!-- KPIs -->
  <section class="kpis" id="kpis">
    <article class="kpi-card">
      <div class="kpi-title">Estoque total (Soja+Milho+Trigo+Lenha)</div>
      <div class="kpi-value" id="kpi-estoque">--</div>
      <div class="kpi-hint" id="kpi-estoque-hint">última atualização</div>
    </article>
    <article class="kpi-card">
      <div class="kpi-title">Meta média (%)</div>
      <div class="kpi-value" id="kpi-meta">--%</div>
      <div class="kpi-hint">progresso médio das metas</div>
    </article>
    <article class="kpi-card">
      <div class="kpi-title">Ocupação Armazenagem</div>
      <div class="kpi-value" id="kpi-armazenamento">--%</div>
      <div class="kpi-hint">utilizado / capacidade</div>
    </article>
    <article class="kpi-card">
      <div class="kpi-title">Ativação de Pessoas</div>
      <div class="kpi-value" id="kpi-pessoas">--%</div>
      <div class="kpi-hint">ativos / total</div>
    </article>
  </section>

  <main class="main" id="cards">
    <!-- SOJA -->
    <article class="card" data-key="soja" data-cat="estoques">
      <div class="card-header">
        <img class="card-thumb" alt="Soja" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSLphsgF8Gd-H382zicb-9935K4CkmAT6fMeg&s"/>
        <div><div class="card-title">Soja</div><div class="card-sub">Estoque, meta, recebimento</div></div>
      </div>
      <div class="card-body">
        <div class="kv" id="detalhes-soja">
          <div><b>Estoque:</b> <span data-f="estoque">--</span></div>
          <div><b>Meta:</b> <span data-f="meta">--</span></div>
          <div><b>Recebimento:</b> <span data-f="recebimento">--</span></div>
        </div>
        <div class="kpi">
          <span class="badge">Meta: <strong><span data-f="percentual">--</span>%</strong></span>
          <div class="progress"><i data-prog="soja"></i></div>
          <svg class="spark" data-spark="soja" viewBox="0 0 120 36" preserveAspectRatio="none"></svg>
        </div>
      </div>
      <div class="card-footer"><div class="price" id="preco-soja">R$: --</div><button class="btn" data-open="soja">Editar</button></div>
    </article>

    <!-- MILHO -->
    <article class="card" data-key="milho" data-cat="estoques">
      <div class="card-header">
        <img class="card-thumb" alt="Milho" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQVd159ggYNLzjL2MPJhQyGUtgdX8M5i-NzTYROTaA&usqp=CAE&s"/>
        <div><div class="card-title">Milho</div><div class="card-sub">Estoque, meta, recebimento</div></div>
      </div>
      <div class="card-body">
        <div class="kv" id="detalhes-milho">
          <div><b>Estoque:</b> <span data-f="estoque">--</span></div>
          <div><b>Meta:</b> <span data-f="meta">--</span></div>
          <div><b>Recebimento:</b> <span data-f="recebimento">--</span></div>
        </div>
        <div class="kpi">
          <span class="badge">Meta: <strong><span data-f="percentual">--</span>%</strong></span>
          <div class="progress"><i data-prog="milho"></i></div>
          <svg class="spark" data-spark="milho" viewBox="0 0 120 36" preserveAspectRatio="none"></svg>
        </div>
      </div>
      <div class="card-footer"><div class="price" id="preco-milho">R$: --</div><button class="btn" data-open="milho">Editar</button></div>
    </article>

    <!-- TRIGO -->
    <article class="card" data-key="trigo" data-cat="estoques">
      <div class="card-header">
        <img class="card-thumb" alt="Trigo" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTtL6y0XCKHFwnkmhJUK-CBSo-ryYeQVaCzGw&s"/>
        <div><div class="card-title">Trigo</div><div class="card-sub">Estoque, meta, recebimento</div></div>
      </div>
      <div class="card-body">
        <div class="kv" id="detalhes-trigo">
          <div><b>Estoque:</b> <span data-f="estoque">--</span></div>
          <div><b>Meta:</b> <span data-f="meta">--</span></div>
          <div><b>Recebimento:</b> <span data-f="recebimento">--</span></div>
        </div>
        <div class="kpi">
          <span class="badge">Meta: <strong><span data-f="percentual">--</span>%</strong></span>
          <div class="progress"><i data-prog="trigo"></i></div>
          <svg class="spark" data-spark="trigo" viewBox="0 0 120 36" preserveAspectRatio="none"></svg>
        </div>
      </div>
      <div class="card-footer"><div class="price" id="preco-trigo">R$: --</div><button class="btn" data-open="trigo">Editar</button></div>
    </article>

    <!-- LENHA -->
    <article class="card" data-key="lenha" data-cat="estoques">
      <div class="card-header">
        <img class="card-thumb" alt="Lenha" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTPJnIDHFXiBgXriQjlGQXgkkhvN2Ngho0Jxg&s"/>
        <div><div class="card-title">Lenha</div><div class="card-sub">Estoque, meta, recebimento</div></div>
      </div>
      <div class="card-body">
        <div class="kv" id="detalhes-lenha">
          <div><b>Estoque:</b> <span data-f="estoque">--</span></div>
          <div><b>Meta:</b> <span data-f="meta">--</span></div>
          <div><b>Recebimento:</b> <span data-f="recebimento">--</span></div>
        </div>
        <div class="kpi">
          <span class="badge">Meta: <strong><span data-f="percentual">--</span>%</strong></span>
          <div class="progress"><i data-prog="lenha"></i></div>
          <svg class="spark" data-spark="lenha" viewBox="0 0 120 36" preserveAspectRatio="none"></svg>
        </div>
      </div>
      <div class="card-footer"><div class="price" id="preco-lenha">R$: --</div><button class="btn" data-open="lenha">Editar</button></div>
    </article>

    <!-- ARMAZENAMENTO -->
    <article class="card" data-key="armazenamento" data-cat="armazenagem">
      <div class="card-header">
        <img class="card-thumb" alt="Silo" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSmsou--klhnzJRP7pddsZf-W0XWl4bKUj2kA&s"/>
        <div><div class="card-title">Armazenamento</div><div class="card-sub">Capacidade, utilizado, disponível</div></div>
      </div>
      <div class="card-body">
        <div class="kv" id="detalhes-armazenamento">
          <div><b>Capacidade:</b> <span data-f="capacidade">--</span></div>
          <div><b>Utilizado:</b> <span data-f="utilizado">--</span></div>
          <div><b>Disponível:</b> <span data-f="disponivel">--</span></div>
        </div>
        <div class="kpi">
          <span class="badge">Ocupação</span>
          <div class="progress"><i data-prog="armazenamento"></i></div>
        </div>
      </div>
      <div class="card-footer"><div class="price" id="preco-armazenamento">R$: --</div><button class="btn" data-open="armazenamento">Editar</button></div>
    </article>

    <!-- PESSOAS -->
    <article class="card" data-key="pessoa" data-cat="pessoas">
      <div class="card-header">
        <img class="card-thumb" alt="Equipe" src="https://images.unsplash.com/photo-1551836022-4c4c79ecde51?q=80&w=320&auto=format&fit=crop"/>
        <div><div class="card-title">Pessoas</div><div class="card-sub">Funcionários, ativos e inativos</div></div>
      </div>
      <div class="card-body">
        <div class="kv" id="detalhes-pessoa">
          <div><b>Orçado:</b> <span data-f="total">--</span></div>
          <div><b>Ativos:</b> <span data-f="ativos">--</span></div>
          <div><b>Inativos:</b> <span data-f="inativos">--</span></div>
        </div>
        <div class="kpi">
          <span class="badge">Ativação</span>
          <div class="progress"><i data-prog="pessoa"></i></div>
        </div>
      </div>
      <div class="card-footer"><div class="price" id="preco-pessoa">R$: --</div><button class="btn" data-open="pessoa">Editar</button></div>
    </article>

    <!-- ESTOQUE GERAL -->
    <article class="card" data-key="geral" data-cat="estoques">
      <div class="card-header">
        <img class="card-thumb" alt="Estoque geral" src="data:image/jpeg;base64,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"/>
        <div><div class="card-title">Estoque Geral</div><div class="card-sub">Total, entrada, saída e saldo</div></div>
      </div>
      <div class="card-body">
        <div class="kv" id="detalhes-geral">
          <div><b>Total:</b> <span data-f="estoque_total">--</span></div>
          <div><b>Entrada:</b> <span data-f="entrada">--</span></div>
          <div><b>Saída:</b> <span data-f="saida">--</span></div>
          <div><b>Saldo:</b> <span data-f="saldo">--</span></div>
        </div>
      </div>
      <div class="card-footer"><div class="price" id="preco-geral">R$: --</div><button class="btn" data-open="geral">Editar</button></div>
    </article>
  </main>

  <!-- Materiais -->
  <section class="materials">
    <h3>Materiais sobre Agronegócio</h3>
    <div class="grid" id="materialsGrid"></div>
  </section>

  <div class="overlay" id="overlay" aria-hidden="true" role="dialog" aria-modal="true">
    <form class="form" id="form" novalidate>
      <button type="button" class="close" aria-label="Fechar" title="Fechar">✕</button>
      <h2 id="form-title">Cadastro</h2>
      <input type="hidden" id="context" />
      <div class="fields"></div>
      <div class="actions">
        <button type="button" class="btn btn-secondary" data-cancel>Cancelar</button>
        <button type="submit" class="btn">Salvar</button>
      </div>
      <div class="form-msg" aria-live="polite" style="height:1.1em;color:var(--accent);"></div>
    </form>
  </div>

  <div class="toast" id="toast">Salvo com sucesso.</div>

  <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

  // ========= Helpers =========
  const $ = (q,root=document)=>root.querySelector(q);
  const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));
  function showToast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1800); }
  function normalizeNumber(v){ if(v===''||v==null) return null; const n=Number(v.toString().replace(',','.')); return isFinite(n)?n:v; }

  // ========= Supabase =========
  const SUPABASE_URL = 'https://dylziaqkyavkfwjepqkp.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5bHppYXFreWF2a2Z3amVwcWtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0NTc1OTgsImV4cCI6MjA2ODAzMzU5OH0.gy5jXxKOTgeCf0Rwq7ktLTz1pyoZ8dJjZOK9UB9rHCM';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ========= Config DB =========
  const dbConfig = {
    soja: { table:'soja',  orderBy:'timestamp', map:{ estoque:'estoqueatual', meta:'meta', recebimento:'recebimento', percentual:'percentual_metal' } },
    milho:{ table:'milho', orderBy:'timestamp', map:{ estoque:'estoqueatual', meta:'meta', recebimento:'recebimento', percentual:'percentual_metal' } },
    trigo:{ table:'trigo', orderBy:'id',        map:{ estoque:'estoque', meta:'meta', recebimento:'recebimento', percentual:'percentual' } },
    lenha:{ table:'lenha', orderBy:'id',        map:{ estoque:'compra_anual_lenha', meta:'media_compra_lenha', recebimento:'baixa_lenha', percentual:'estoque_atual_lenha' } },
    armazenamento:{ table:'capacidade_estatica_unidade', orderBy:'id', map:{ capacidade:'capacidade_estatica', utilizado:'capacidade_real', disponivel:'estoque_atual' } },
    pessoa:{ table:'funcionario_employer', orderBy:'id', map:{ total:'quantidade_orcado', ativos:'quantidade_ativo', inativos:'quantidade_funcionario_employer' } },
    geral:{ table:'geral', orderBy:'created_at', map:{ estoque_total:'estoque_total', entrada:'entrada', saida:'saida', saldo:'saldo' } },
  };

  // ========= Schemas (Form) =========
  const schemas = {
    soja:{title:'Cadastro Soja',fields:[
      {key:'estoque',label:'Estoque Atual',type:'number',required:true,step:'0.01',hint:'Quantidade atual (t)'},
      {key:'meta',label:'Meta',type:'number',required:true,step:'0.01',hint:'Objetivo (t)'},
      {key:'recebimento',label:'Recebimento',type:'number',required:true,step:'0.01',hint:'Entrada prevista (t)'},
      {key:'percentual',label:'Percentual Meta (%)',type:'number',readonly:true,hint:'Calculado automaticamente'}
    ]},
    milho:{title:'Cadastro Milho',fields:[
      {key:'estoque',label:'Estoque Atual',type:'number',required:true,step:'0.01',hint:'Quantidade atual (t)'},
      {key:'meta',label:'Meta',type:'number',required:true,step:'0.01',hint:'Objetivo (t)'},
      {key:'recebimento',label:'Recebimento',type:'number',required:true,step:'0.01',hint:'Entrada prevista (t)'},
      {key:'percentual',label:'Percentual Meta (%)',type:'number',readonly:true,hint:'Calculado automaticamente'}
    ]},
    trigo:{title:'Cadastro Trigo',fields:[
      {key:'estoque',label:'Estoque Atual',type:'number',required:true,step:'0.01',hint:'Quantidade atual (t)'},
      {key:'meta',label:'Meta',type:'number',required:true,step:'0.01',hint:'Objetivo (t)'},
      {key:'recebimento',label:'Recebimento',type:'number',required:true,step:'0.01',hint:'Entrada prevista (t)'},
      {key:'percentual',label:'Percentual Meta (%)',type:'number',readonly:true,hint:'Calculado automaticamente'}
    ]},
    lenha:{title:'Cadastro Lenha',fields:[
      {key:'estoque',label:'Estoque Atual',type:'number',required:true,step:'0.01',hint:'Quantidade atual'},
      {key:'meta',label:'Meta',type:'number',required:true,step:'0.01',hint:'Objetivo'},
      {key:'recebimento',label:'Recebimento',type:'number',required:true,step:'0.01',hint:'Entrada prevista'},
      {key:'percentual',label:'Percentual Meta (%)',type:'number',readonly:true,hint:'Calculado automaticamente'}
    ]},
    armazenamento:{title:'Cadastro Armazenamento',fields:[
      {key:'capacidade',label:'Capacidade Total',type:'number',required:true,step:'0.01',hint:'Capacidade dos silos (t)'},
      {key:'utilizado',label:'Utilizado',type:'number',required:true,step:'0.01',hint:'Volume ocupado (t)'},
      {key:'disponivel',label:'Disponível',type:'number',required:false,readonly:true,step:'0.01',hint:'Calculado: capacidade - utilizado'}
    ]},
    pessoa:{title:'Cadastro Pessoa',fields:[
      {key:'total',label:'Total de Funcionários',type:'number',required:true,step:'1',hint:'Quantidade total'},
      {key:'ativos',label:'Ativos',type:'number',required:true,step:'1',hint:'Funcionando no momento'},
      {key:'inativos',label:'Inativos',type:'number',required:true,step:'1',hint:'Afastados ou férias'}
    ]},
    geral:{title:'Cadastro Estoque Geral',fields:[
      {key:'estoque_total',label:'Estoque Total',type:'number',required:true,step:'0.01',hint:'Consolidado (t)'},
      {key:'entrada',label:'Entrada',type:'number',required:true,step:'0.01',hint:'Entradas no período'},
      {key:'saida',label:'Saída',type:'number',required:true,step:'0.01',hint:'Saídas no período'},
      {key:'saldo',label:'Saldo',type:'number',required:true,step:'0.01',hint:'Total - Saídas + Entradas'}
    ]}
  };

  // ========= Materiais =========
  const materials = [
    { title:'Conab – Acompanhamento de Safras', url:'https://www.conab.gov.br/', tag:'Safras', desc:'Boletins, estimativas e preços.' },
    { title:'EMBRAPA – Tecnologias e Sistemas de Produção', url:'https://www.embrapa.br/', tag:'Tecnologia', desc:'Boas práticas, cultivares e manejo.' },
    { title:'MAPA – Ministério da Agricultura', url:'https://www.gov.br/agricultura/pt-br', tag:'Políticas', desc:'Regulações, programas e notícias.' },
    { title:'Cepea/Esalq – Indicadores de Preços', url:'https://www.cepea.esalq.usp.br/', tag:'Mercado', desc:'Indicadores de soja, milho, boi, etc.' },
    { title:'CNA – Canal do Produtor', url:'https://www.cnabrasil.org.br/', tag:'CNA', desc:'Conteúdos e serviços para produtores.' }
  ];
  const grid = $('#materialsGrid');
  grid.innerHTML = materials.map(m=>`<article class="res-card"><span class="tag">${m.tag}</span><a href="${m.url}" target="_blank" rel="noopener">${m.title}</a><span class="desc">${m.desc}</span></article>`).join('');

  // ========= State & Mappers =========
  const state = { soja:{}, milho:{}, trigo:{}, lenha:{}, armazenamento:{}, pessoa:{}, geral:{}, _series:{} };
  const invert = (obj)=>Object.fromEntries(Object.entries(obj).map(([a,b])=>[b,a]));
  const toDb = (key, uiRow)=>{ const map=dbConfig[key].map||{}; const out={}; Object.entries(uiRow).forEach(([k,v])=>out[map[k]||k]=v); return out; };
  const fromDb = (key, dbRow)=>{ const rev=invert(dbConfig[key].map||{}); const out={}; Object.entries(dbRow||{}).forEach(([k,v])=>out[rev[k]||k]=v); return out; };
  const mapFieldToDb = (key, uiField)=> (dbConfig[key].map||{})[uiField] || uiField;

  // ========= UI Refs =========
  const overlay = $('#overlay');
  const form = $('#form');
  const fieldsBox = form.querySelector('.fields');
  const formTitle = $('#form-title');
  const contextInput = $('#context');
  const themeToggle = $('#themeToggle');
  const refreshBtn = $('#refreshBtn');
  const tabs = $('#tabs');
  const kpisEl = $('#kpis');
  const tabIndicator = $('.tab-indicator', tabs);

  // ========= Tabs =========
  function positionIndicator(){
    const active = $('.tab.active', tabs);
    if(!active || !tabIndicator) return;
    const r = active.getBoundingClientRect();
    const t = tabs.getBoundingClientRect();
    tabIndicator.style.left = (r.left - t.left + 10) + 'px';
    tabIndicator.style.width = (r.width - 20) + 'px';
  }
  function setTab(cat){
    $$('.tab', tabs).forEach(b=>b.classList.toggle('active', b.dataset.cat===cat));
    localStorage.setItem('tab',cat);
    kpisEl.style.display = (cat==='operacao') ? 'grid' : 'none';
    $$('.main .card').forEach(card=>{
      const c = card.dataset.cat || 'operacao';
      const show = cat==='operacao' ? true : (c===cat);
      card.style.display = show ? 'grid' : 'none';
    });
    requestAnimationFrame(positionIndicator);
  }
  tabs.addEventListener('click', (e)=>{
    const btn = e.target.closest('.tab');
    if(!btn) return;
    setTab(btn.dataset.cat);
  });
  setTab(localStorage.getItem('tab') || 'operacao');
  window.addEventListener('resize', positionIndicator);

  // ========= Tema (CORRIGIDO: aplica no <html>) =========
  const root = document.documentElement;
  function applyTheme(theme){
    const isDark = theme === 'dark';
    if (isDark) root.setAttribute('data-theme','dark');
    else root.removeAttribute('data-theme');
    root.style.colorScheme = isDark ? 'dark' : 'light';
    themeToggle.setAttribute('aria-pressed', String(isDark));
  }
  const savedTheme = localStorage.getItem('theme');
  const initial = savedTheme || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  applyTheme(initial);
  themeToggle.addEventListener('click',()=>{
    const next = root.getAttribute('data-theme')==='dark' ? 'light' : 'dark';
    localStorage.setItem('theme', next);
    applyTheme(next);
  });

  // ========= Atalhos =========
  window.addEventListener('keydown', (e)=>{
    if(e.altKey||e.ctrlKey||e.metaKey) return;
    const k=e.key.toLowerCase();
    if(k==='1') return setTab('operacao');
    if(k==='2') return setTab('estoques');
    if(k==='3') return setTab('pessoas');
    if(k==='4') return setTab('armazenagem');
    if(k==='t') return themeToggle.click();
    if(k==='r') return refreshBtn.click();
    if(k==='n') return openForm('soja');
  });

  // ========= Formulário =========
  function openForm(key){
    const schema = schemas[key]; if(!schema) return;
    formTitle.textContent = schema.title; contextInput.value = key; fieldsBox.innerHTML='';
    const frag = document.createDocumentFragment();
    schema.fields.forEach(f=>{
      const id = `f_${key}_${f.key}`;
      const wrap = document.createElement('div'); wrap.className='field';
      wrap.innerHTML = `<label for="${id}" class="label">${f.label}${f.required?' *':''}</label>
        <input id="${id}" class="input" inputmode="decimal" ${f.readonly?'readonly':''} type="${f.type}" data-key="${f.key}" ${f.required?'required':''} ${f.step?`step="${f.step}"`:''}/>`+
        `${f.hint?`<div class="hint">${f.hint}</div>`:''}`+
        `<div class="error-msg" data-err="${f.key}"></div>`;
      frag.appendChild(wrap);
    });
    fieldsBox.appendChild(frag);
    const current = state[key] || {};
    fieldsBox.querySelectorAll('input').forEach(i=>{ const k=i.dataset.key; if(current[k]!=null) i.value=current[k]; });
    maybeWirePercentCalc();
    maybeWireStorageCalc();
    showOverlay();
    fieldsBox.querySelector('input:not([readonly])')?.focus();
  }
  function maybeWirePercentCalc(){
    const pct = fieldsBox.querySelector('input[data-key="percentual"]'); if(!pct) return;
    const meta = fieldsBox.querySelector('input[data-key="meta"]');
    const recebimento = fieldsBox.querySelector('input[data-key="recebimento"]');
    const calc = ()=>{
      const m = parseFloat(meta?.value);
      const r = parseFloat(recebimento?.value);
      pct.value = (isFinite(m) && isFinite(r) && m > 0) ? ((r / m) * 100).toFixed(1) : '';
    };
    meta?.addEventListener('input', calc);
    recebimento?.addEventListener('input', calc);
    calc();
  }
  function maybeWireStorageCalc(){
    const cap = fieldsBox.querySelector('input[data-key="capacidade"]');
    const uti = fieldsBox.querySelector('input[data-key="utilizado"]');
    const disp = fieldsBox.querySelector('input[data-key="disponivel"]');
    if(!cap||!uti||!disp) return;
    const calc = ()=>{
      const c = parseFloat(cap.value), u = parseFloat(uti.value);
      disp.value = (isFinite(c)&&isFinite(u)) ? Math.max(0, c - u).toFixed(2) : '';
    };
    cap.addEventListener('input',calc); uti.addEventListener('input',calc); calc();
  }
  function showOverlay(){ overlay.classList.add('active'); overlay.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
  function hideOverlay(){ overlay.classList.remove('active'); overlay.setAttribute('aria-hidden','true'); document.body.style.overflow=''; form.reset(); fieldsBox.innerHTML=''; }
  overlay.addEventListener('click',e=>{ if(e.target===overlay) hideOverlay(); });
  form.querySelector('.close').addEventListener('click', hideOverlay);
  form.querySelector('[data-cancel]').addEventListener('click', hideOverlay);
  window.addEventListener('keydown',e=>{ if(e.key==='Escape'&&overlay.classList.contains('active')) hideOverlay(); });

  // Submit -> insert (com validação)
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const submitBtn = form.querySelector('button[type="submit"]');
    const key = contextInput.value; const { table } = dbConfig[key];
    const inputs = [...fieldsBox.querySelectorAll('input')];

    // limpa erros
    let firstError=null; inputs.forEach(i=>{ const el=fieldsBox.querySelector(`[data-err="${i.dataset.key}"]`); if(el) el.textContent=''; i.classList.remove('error'); });
    // valida
    for(const i of inputs){
      if(i.hasAttribute('required') && !i.value){
        fieldsBox.querySelector(`[data-err="${i.dataset.key}"]`).textContent='Campo obrigatório';
        i.classList.add('error'); if(!firstError) firstError=i;
      }
      if(i.type==='number' && i.value){ const n=Number(i.value.replace(',','.')); if(Number.isNaN(n)){ fieldsBox.querySelector(`[data-err="${i.dataset.key}"]`).textContent='Número inválido'; i.classList.add('error'); if(!firstError) firstError=i; }}
    }
    if(firstError){ firstError.focus(); return; }

    // (re)calcula derivados
    const metaI = fieldsBox.querySelector('input[data-key="meta"]');
    const recI  = fieldsBox.querySelector('input[data-key="recebimento"]');
    const pctI  = fieldsBox.querySelector('input[data-key="percentual"]');
    if(pctI && metaI && recI){
      const m = parseFloat(metaI.value);
      const r = parseFloat(recI.value);
      pctI.value = (isFinite(m) && isFinite(r) && m > 0) ? ((r / m) * 100).toFixed(1) : '';
    }
    const capI = fieldsBox.querySelector('input[data-key="capacidade"]');
    const utiI = fieldsBox.querySelector('input[data-key="utilizado"]');
    const dispI= fieldsBox.querySelector('input[data-key="disponivel"]');
    if(capI && utiI && dispI){
      const c = parseFloat(capI.value), u = parseFloat(utiI.value);
      dispI.value = (isFinite(c) && isFinite(u)) ? Math.max(0, c - u).toFixed(2) : '';
    }

    const uiRow = Object.fromEntries(inputs.map(i=>[i.dataset.key, normalizeNumber(i.value)]));
    if('percentual' in uiRow){
      const v = Number(uiRow.percentual);
      if(!isFinite(v)) delete uiRow.percentual;
    }
    const dbRow = toDb(key, uiRow);

    submitBtn.disabled=true; const oldText=submitBtn.textContent; submitBtn.textContent='Salvando...';
    const { data, error } = await supabase.from(table).insert(dbRow).select().single();
    submitBtn.disabled=false; submitBtn.textContent=oldText;

    if(error){ showToast('Erro ao salvar: '+error.message); return; }
    state[key] = fromDb(key, data);
    updateCard(key);
    hideOverlay();
    showToast('Salvo com sucesso.');
  });

  // ========= Fetch & Realtime =====
  function primaryDbColumnForSeries(key){
    if(['soja','milho','trigo','lenha'].includes(key)) return mapFieldToDb(key,'estoque');
    if(key==='geral') return mapFieldToDb(key,'estoque_total');
    if(key==='armazenamento') return mapFieldToDb(key,'utilizado');
    if(key==='pessoa') return mapFieldToDb(key,'total');
    return null;
  }

  async function fetchLatest(key){
    const { table, orderBy } = dbConfig[key];
    let { data, error } = await supabase.from(table).select('*').order(orderBy,{ascending:false}).limit(1);
    if(!error && data && data[0]){ state[key]=fromDb(key, data[0]); updateCard(key); }
    const col = primaryDbColumnForSeries(key); if(!col) return;
    const { data: series, error: sErr } = await supabase.from(table).select(col).order(orderBy,{ascending:false}).limit(12);
    if(!sErr && series){
      const arr = series.map(r=>Number(r[col])).filter(n=>isFinite(n)).reverse();
      state._series[key]=arr; drawSpark(key, arr);
    }
  }

  async function loadAll(){
    $$('.card').forEach(c=>c.classList.add('loading'));
    await Promise.all(Object.keys(dbConfig).map(k=>fetchLatest(k)));
    $$('.card').forEach(c=>c.classList.remove('loading'));
    updateKpis();
    updateBadges();
    positionIndicator();
  }

  // Realtime INSERT
  Object.entries(dbConfig).forEach(([key,{table}])=>{
    supabase.channel(`realtime:${table}`)
      .on('postgres_changes',{ event:'INSERT', schema:'public', table },(payload)=>{
        state[key]=fromDb(key, payload.new);
        updateCard(key);
      })
      .subscribe();
  });

  // ========= UI Update =========
  function drawSpark(key, arr){
    const svg = document.querySelector(`[data-spark="${key}"]`); if(!svg) return;
    const w=120, h=36; if(!arr || arr.length<2){ svg.innerHTML=''; return; }
    const min=Math.min(...arr), max=Math.max(...arr); const pad=3;
    const scaleX = (i)=> (i/(arr.length-1))*(w-2*pad)+pad;
    const scaleY = (v)=> h-pad - (max===min?0:( (v-min)/(max-min) )*(h-2*pad));
    const d = arr.map((v,i)=> (i?'L':'M')+scaleX(i)+','+scaleY(v)).join(' ');
    svg.innerHTML = `<path d="${d}" fill="none" stroke="currentColor" stroke-width="2" opacity="0.85"/>
                     <circle cx="${scaleX(arr.length-1)}" cy="${scaleY(arr[arr.length-1])}" r="2.5" fill="currentColor"/>`;
  }

  function updateKpis(){
    const keysEstoque=['soja','milho','trigo','lenha'];
    const somaEstoque = keysEstoque.map(k=>Number(state[k]?.estoque)).filter(isFinite).reduce((a,b)=>a+b,0);
    $('#kpi-estoque').textContent = somaEstoque? new Intl.NumberFormat('pt-BR').format(somaEstoque) : '--';
    $('#kpi-estoque-hint').textContent = 'atualizado ' + new Date().toLocaleString('pt-BR');

    // Meta média (%) = recebimento / meta * 100
    const percentuais = keysEstoque.map(k=>{
      const m=Number(state[k]?.meta);
      const r=Number(state[k]?.recebimento);
      return (isFinite(m) && isFinite(r) && m>0) ? (r/m*100) : null;
    }).filter(v=>v!=null);
    const media = percentuais.length? (percentuais.reduce((a,b)=>a+b,0)/percentuais.length) : null;
    $('#kpi-meta').textContent = media? media.toFixed(1)+'%' : '--%';

    const u=Number(state.armazenamento?.utilizado), c=Number(state.armazenamento?.capacidade);
    const occ=(isFinite(u)&&isFinite(c)&&c>0)?(u/c*100):null;
    $('#kpi-armazenamento').textContent = occ? occ.toFixed(1)+'%' : '--%';

    const a=Number(state.pessoa?.ativos), t=Number(state.pessoa?.total);
    const ativ=(isFinite(a)&&isFinite(t)&&t>0)?(a/t*100):null;
    $('#kpi-pessoas').textContent = ativ? ativ.toFixed(1)+'%' : '--%';
  }

  function setProgressBar(i, pct){
    i.classList.remove('bad','warn','ok');
    if(pct < 50) i.classList.add('bad');
    else if(pct < 90) i.classList.add('warn');
    else i.classList.add('ok');
    i.style.width = pct + '%';
  }

  function updateCard(key){
    const card = document.querySelector(`.card[data-key="${key}"]`); if(!card) return;
    const data = state[key] || {};
    card.querySelectorAll('[data-f]').forEach(span=>{
      const k=span.getAttribute('data-f');
      let val=data?.[k];
      if(typeof val==='number') val=new Intl.NumberFormat('pt-BR').format(val);
      span.textContent=(val??'--');
    });

    const i = card.querySelector(`[data-prog="${key}"]`);
    if(i){
      let pct = 0;
      if(['soja','milho','trigo','lenha'].includes(key)){
        const m = Number(data?.meta); const r = Number(data?.recebimento);
        pct = isFinite(m) && isFinite(r) && m>0 ? Math.max(0, Math.min(100, (r/m)*100)) : 0;
      }
      if(key==='armazenamento'){
        const u = Number(data?.utilizado); const c = Number(data?.capacidade);
        pct = isFinite(u)&&isFinite(c)&&c>0 ? Math.max(0, Math.min(100, (u/c)*100)) : 0;
      }
      if(key==='pessoa'){
        const a = Number(data?.ativos); const t = Number(data?.total);
        pct = isFinite(a)&&isFinite(t)&&t>0 ? Math.max(0, Math.min(100, (a/t)*100)) : 0;
      }
      setProgressBar(i, pct);
      const pctSpan = card.querySelector('[data-f="percentual"]');
      if(pctSpan && !pctSpan.textContent.trim()) pctSpan.textContent = pct.toFixed(1);
    }

    const price = card.querySelector('.price');
    if(price){
      const numbers = Object.values(data||{}).map(v=>Number(v)).filter(v=>isFinite(v));
      price.textContent = numbers.length?`R$: ${new Intl.NumberFormat('pt-BR',{maximumFractionDigits:2}).format(numbers[0])}`:'R$: --';
    }

    if(state._series[key]) drawSpark(key, state._series[key]);

    updateKpis();
    updateBadges();
  }

  // ========= Bind Botões =========
  $$('.btn[data-open]').forEach(btn=>btn.addEventListener('click',()=>openForm(btn.dataset.open)));
  refreshBtn.addEventListener('click',()=>{ loadAll(); showToast('Atualizado'); });

  // ========= Start =========
  (async()=>{ await loadAll(); })();

  // ========= Badges/Barras =========
  function updateBadges(){
    ['soja','milho','trigo','lenha'].forEach(key=>{
      const card = document.querySelector(`.card[data-key="${key}"]`); if(!card) return;
      const span = card.querySelector('[data-f="percentual"]');
      let pct = Number(state[key]?.percentual);
      if(!isFinite(pct)){
        const m = Number(state[key]?.meta); const r = Number(state[key]?.recebimento);
        pct = (isFinite(m) && isFinite(r) && m>0) ? (r/m*100) : NaN;
      }
      if(isFinite(pct)){
        span.textContent = Number(pct).toFixed(1);
        const bar = card.querySelector(`[data-prog="${key}"]`); if(bar) setProgressBar(bar, Math.max(0,Math.min(100,pct)));
      }
    });
    // Armazenamento
    (function(){
      const key='armazenamento'; const card=document.querySelector(`.card[data-key="${key}"]`); if(!card) return;
      const u=Number(state[key]?.utilizado), c=Number(state[key]?.capacidade);
      const pct=isFinite(u)&&isFinite(c)&&c>0?(u/c*100):NaN; const bar=card.querySelector('[data-prog="armazenamento"]');
      if(bar&&isFinite(pct)) setProgressBar(bar, Math.max(0,Math.min(100,pct)));
    })();
    // Pessoas
    (function(){
      const key='pessoa'; const card=document.querySelector(`.card[data-key="${key}"]`); if(!card) return;
      const a=Number(state[key]?.ativos), t=Number(state[key]?.total);
      const pct=isFinite(a)&&isFinite(t)&&t>0?(a/t*100):NaN; const bar=card.querySelector('[data-prog="pessoa"]');
      if(bar&&isFinite(pct)) setProgressBar(bar, Math.max(0,Math.min(100,pct)));
    })();
  }
</script>

</body>
</html>
